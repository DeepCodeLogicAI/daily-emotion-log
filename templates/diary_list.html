
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚´ ë§ˆìŒ ë³´ê´€í•¨ - MindDiary AI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
{% include "header.html" %}

<div class="card" style="background: transparent; box-shadow: none; border: none; padding: 0 20px;">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <h2 style="text-align: left; margin: 0;">ğŸ“” ë‚´ ë§ˆìŒ ë³´ê´€í•¨</h2>
    <a href="/diary" class="btn submit" style="flex: none; padding: 10px 20px; font-size: 14px;">âœï¸ ìƒˆ ê¸€ ì“°ê¸°</a>
  </div>
</div>

{% if recent_scores|length > 0 %}
<div class="card">
  <h3 style="text-align: center; color: #1e293b; font-size: 18px; font-weight: 700; margin-top: 0; margin-bottom: 24px;">ğŸ“Š ìµœê·¼ 5ì¼ ê°ì • ë³€í™”</h3>
  <canvas id="emotionChart" style="max-height: 300px;"></canvas>
</div>
{% endif %}

{% if diaries|length == 0 %}
<div class="card empty-card">
  <div class="empty-icon">ğŸ‚</div>
  <p style="color: #94a3b8; font-size: 15px;">ì•„ì§ ê¸°ë¡ëœ ë§ˆìŒì´ ì—†ë„¤ìš”.<br>ì²« ë²ˆì§¸ ì´ì•¼ê¸°ë¥¼ ì‹œì‘í•´ë³¼ê¹Œìš”?</p>
  <div style="margin-top: 24px;">
    <a href="/diary" class="btn submit" style="max-width: 200px; display: inline-block;">ì¼ê¸° ì‘ì„±í•˜ê¸°</a>
  </div>
</div>
{% else %}
  {% for d in diaries %}
  <div class="card diary-item">
    <div class="diary-header">
      <span class="date-badge">{{ d.diary_date }}</span>
      <span class="emotion-badge emotion-{{ d.emotion }}">{{ d.emotion }}</span>
    </div>

    <div class="diary-content">
      <p style="margin:0; white-space: pre-wrap;">{{ d.content }}</p>
    </div>

    {% if d.analysis %}
    <div class="ai-box">
      <h4>âœ¨ AIê°€ ë³´ë‚´ëŠ” ë”°ëœ»í•œ ë©”ì‹œì§€</h4>
      <p class="summary-text">"{{ d.analysis.summary }}"</p>
    </div>
    {% endif %}
  </div>
  {% endfor %}
{% endif %}

<div style="height: 60px;"></div>

{% if recent_scores|length > 0 %}
<script>
  const recentScores = {{ recent_scores | tojson }};
  
  // ë‚ ì§œ í¬ë§·íŒ… (MM/DD í˜•ì‹)
  const dates = recentScores.map(item => {
    const date = new Date(item.diary_date);
    return (date.getMonth() + 1) + '/' + date.getDate();
  });
  
  // emotion_score ê°’ ì¶”ì¶œ
  const scores = recentScores.map(item => item.emotion_score !== null ? item.emotion_score : 2);
  
  // ê°ì • ë¼ë²¨ ë§¤í•‘
  const emotionLabels = {0: 'ë¶„ë…¸', 1: 'ìš°ìš¸', 2: 'ë³´í†µ', 3: 'í–‰ë³µ'};
  const emotionColors = {
    0: 'rgba(220, 38, 38, 0.8)',   // ë¶„ë…¸ - ë¹¨ê°„ìƒ‰
    1: 'rgba(79, 70, 229, 0.8)',   // ìš°ìš¸ - ë³´ë¼ìƒ‰
    2: 'rgba(2, 132, 199, 0.8)',   // ë³´í†µ - íŒŒë€ìƒ‰
    3: 'rgba(217, 119, 6, 0.8)'    // í–‰ë³µ - ì£¼í™©ìƒ‰
  };
  
  // ê°ì • ë¼ë²¨ ë°°ì—´ ìƒì„±
  const emotionNames = recentScores.map(item => emotionLabels[item.emotion_score] || 'ë³´í†µ');
  
  const ctx = document.getElementById('emotionChart').getContext('2d');
  const chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: dates,
      datasets: [{
        label: 'ê°ì • ì ìˆ˜',
        data: scores,
        borderColor: '#fb7185',
        backgroundColor: 'rgba(251, 113, 133, 0.1)',
        borderWidth: 3,
        fill: true,
        tension: 0.4,
        pointRadius: 6,
        pointHoverRadius: 8,
        pointBackgroundColor: '#fb7185',
        pointBorderColor: '#fff',
        pointBorderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      layout: {
        padding: {
          top: 10,
          bottom: 0,
          left: 0,
          right: 0
        }
      },
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const index = context.dataIndex;
              const emotion = emotionNames[index];
              return `ê°ì •: ${emotion} (ì ìˆ˜: ${context.parsed.y})`;
            }
          },
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          padding: 12,
          titleFont: {
            size: 14,
            weight: 'bold'
          },
          bodyFont: {
            size: 13
          },
          cornerRadius: 8
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 3.5,
          ticks: {
            stepSize: 1,
            callback: function(value) {
              if (value <= 3) {
                return emotionLabels[value] || value;
              }
              return '';
            },
            font: {
              size: 12
            }
          },
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          }
        },
        x: {
          ticks: {
            font: {
              size: 12
            }
          },
          grid: {
            display: false
          }
        }
      }
    }
  });
</script>
{% endif %}

</body>
</html>
